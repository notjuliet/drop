<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>drop</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body
    class="bg-bg text-text min-h-screen flex flex-col items-center justify-center px-4 font-sans"
  >
    <div class="w-full max-w-md">
      <h1 class="text-lg font-medium mb-6">
        <a
          href="/"
          class="text-text no-underline hover:text-accent transition-colors"
          >drop</a
        >
      </h1>

      <div
        id="drop-zone"
        class="w-full h-[200px] bg-surface border border-dashed border-border rounded-lg flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-accent transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          class="text-muted"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
          />
        </svg>
        <p class="text-sm text-muted">
          Drop a file or
          <button
            id="browse-btn"
            class="text-accent underline bg-transparent border-none cursor-pointer p-0 text-sm"
          >
            browse
          </button>
        </p>
        <input type="file" id="file-input" class="hidden" />
      </div>

      <div id="file-chip" class="hidden mt-3 flex items-center gap-2">
        <span
          id="selected-file"
          class="inline-flex items-center gap-1.5 bg-surface border border-border rounded-full px-3 py-1 text-xs font-mono text-text"
        ></span>
        <button
          id="remove-file"
          class="text-muted hover:text-text bg-transparent border-none cursor-pointer p-0 text-sm leading-none"
        >
          &times;
        </button>
      </div>

      <div class="flex gap-4 items-center mt-4">
        <input
          id="expiry"
          type="text"
          value="24h"
          placeholder="e.g. 30m, 24h, 7d"
          class="w-24 bg-surface border border-border rounded-md text-text py-1.5 px-2.5 text-xs outline-none focus:border-accent transition-colors"
        />
        <label
          class="text-xs text-muted flex items-center gap-1.5 cursor-pointer select-none"
        >
          <input type="checkbox" id="burn" class="accent-accent" />
          Burn after read
        </label>
      </div>

      <button
        id="submit"
        class="w-full mt-4 bg-accent text-white border-none rounded-md py-2.5 text-sm font-medium cursor-pointer hover:bg-accent-hover disabled:opacity-40 disabled:cursor-not-allowed transition-colors relative overflow-hidden"
      >
        Upload
      </button>

      <div
        id="progress-bar"
        class="hidden w-full h-1 bg-surface rounded-full mt-2 overflow-hidden"
      >
        <div
          id="progress-fill"
          class="h-full bg-accent rounded-full transition-all duration-150"
          style="width: 0%"
        ></div>
      </div>

      <div id="error" class="hidden mt-4 text-danger text-xs"></div>

      <div
        id="result"
        class="hidden mt-6 bg-surface border border-border rounded-lg p-4"
      >
        <label class="text-xs text-muted block mb-1.5">drop link</label>
        <div class="flex gap-2">
          <input
            id="link-input"
            type="text"
            readonly
            class="flex-1 min-w-0 bg-bg border border-border rounded-md text-text py-1.5 px-2.5 text-xs font-mono outline-none"
          />
          <button
            id="copy"
            class="bg-accent text-white border-none rounded-md py-1.5 px-3 text-xs font-medium cursor-pointer hover:bg-accent-hover transition-colors shrink-0"
          >
            Copy
          </button>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <a
            id="delete-url"
            href="#"
            class="text-xs text-muted hover:text-text transition-colors font-mono truncate"
          ></a>
          <button
            id="copy-delete"
            class="text-xs text-muted hover:text-text bg-transparent border-none cursor-pointer p-0 underline shrink-0"
          >
            Copy
          </button>
        </div>
      </div>
    </div>

    <p class="mt-auto pt-8 pb-4 text-[10px] text-muted">end-to-end encrypted</p>

    <!-- hidden anchor for link href -->
    <a id="link" href="#" class="hidden"></a>

    <script type="module">
      import { generateKey, encrypt } from "/crypto.js";

      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const browseBtn = document.getElementById("browse-btn");
      const fileChip = document.getElementById("file-chip");
      const selectedFileEl = document.getElementById("selected-file");
      const removeFileBtn = document.getElementById("remove-file");
      const expiry = document.getElementById("expiry");
      const btn = document.getElementById("submit");
      const progressBar = document.getElementById("progress-bar");
      const progressFill = document.getElementById("progress-fill");
      const result = document.getElementById("result");
      const linkInput = document.getElementById("link-input");
      const linkEl = document.getElementById("link");
      const copyBtn = document.getElementById("copy");
      const deleteUrlEl = document.getElementById("delete-url");
      const copyDeleteBtn = document.getElementById("copy-delete");
      const errorEl = document.getElementById("error");

      let selectedFile = null;

      browseBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        fileInput.click();
      });

      dropZone.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        if (fileInput.files[0]) setFile(fileInput.files[0]);
      });

      // Full-page drag target
      document.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-accent", "bg-accent-subtle");
      });

      document.addEventListener("dragleave", (e) => {
        if (
          e.relatedTarget === null ||
          !document.body.contains(e.relatedTarget)
        ) {
          dropZone.classList.remove("border-accent", "bg-accent-subtle");
        }
      });

      document.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-accent", "bg-accent-subtle");
        if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
      });

      removeFileBtn.addEventListener("click", () => {
        selectedFile = null;
        fileInput.value = "";
        fileChip.classList.add("hidden");
      });

      function setFile(f) {
        selectedFile = f;
        selectedFileEl.textContent = `${f.name} (${formatBytes(f.size)})`;
        fileChip.classList.remove("hidden");
      }

      function formatBytes(n) {
        if (n < 1024) return `${n} B`;
        if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
        if (n < 1024 * 1024 * 1024) return `${(n / 1024 / 1024).toFixed(1)} MB`;
        return `${(n / 1024 / 1024 / 1024).toFixed(2)} GB`;
      }

      btn.addEventListener("click", async () => {
        if (!selectedFile) return;

        btn.disabled = true;
        btn.textContent = "Encrypting\u2026";
        errorEl.classList.add("hidden");
        result.classList.add("hidden");
        progressBar.classList.add("hidden");
        progressFill.style.width = "0%";

        try {
          const { key, encoded } = await generateKey();
          const buffer = await selectedFile.arrayBuffer();
          const ciphertext = await encrypt(selectedFile.name || "file", buffer, key);

          const formData = new FormData();
          formData.append("file", new Blob([ciphertext]));
          formData.append("expiresIn", expiry.value.trim());
          formData.append(
            "burnAfterRead",
            document.getElementById("burn").checked ? "true" : "false",
          );

          btn.textContent = "Uploading\u2026";
          progressBar.classList.remove("hidden");

          const res = await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/file");

            xhr.upload.onprogress = (e) => {
              if (e.lengthComputable) {
                const pct = Math.round((e.loaded / e.total) * 100);
                progressFill.style.width = pct + "%";
                btn.textContent = `Uploading\u2026 ${pct}%`;
              }
            };

            xhr.onload = () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                resolve(JSON.parse(xhr.responseText));
              } else {
                try {
                  const err = JSON.parse(xhr.responseText);
                  reject(new Error(err.error || "Upload failed"));
                } catch {
                  reject(new Error("Upload failed"));
                }
              }
            };

            xhr.onerror = () => reject(new Error("Upload failed"));
            xhr.send(formData);
          });

          const { id, deleteToken } = res;
          const url = `${location.origin}/p/${id}#${encoded}`;
          const deleteUrl = `${location.origin}/delete/${id}?token=${deleteToken}`;
          linkEl.href = url;
          linkInput.value = url;
          deleteUrlEl.href = deleteUrl;
          deleteUrlEl.textContent = "Delete link";
          result.classList.remove("hidden");
          progressBar.classList.add("hidden");
        } catch (e) {
          errorEl.textContent = e.message;
          errorEl.classList.remove("hidden");
          progressBar.classList.add("hidden");
        } finally {
          btn.disabled = false;
          btn.textContent = "Upload";
        }
      });

      copyBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(linkInput.value);
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy"), 1500);
      });

      copyDeleteBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(deleteUrlEl.href);
        copyDeleteBtn.textContent = "Copied!";
        setTimeout(() => (copyDeleteBtn.textContent = "Copy"), 1500);
      });
    </script>
  </body>
</html>
